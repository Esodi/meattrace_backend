{% extends "meat_trace/base.html" %}
{% block title %}Product Information - {{ product.name|default:"Unknown Product" }}{% endblock %}

{% block content %}
    {% if error %}
    <div class="alert alert-danger mt-3">
        <strong>Error:</strong> {{ error }}
    </div>
    {% endif %}
<div class="header-hero">
    <h1>{{ product.name|default:"Unknown Product" }}</h1>
    <p class="mt-2">Product ID: {{ product.id|default:"N/A" }} | Batch: {{ product.batch_number|default:"N/A" }}</p>
</div>

<div class="card mt-4 product-summary">
    <h2>Product Summary</h2>
    <div class="summary-grid">
            <div class="summary-item">
                <h3>Product Details</h3>
                <p><strong>Type:</strong> {{ product.product_type|default:"N/A" }}</p>
                <p><strong>Quantity:</strong> {{ product.quantity|default:"N/A" }} {{ product.weight_unit|default:"" }}</p>
                <p><strong>Weight:</strong> {% if product.weight %}{{ product.weight }} {{ product.weight_unit }}{% else %}Not recorded{% endif %}</p>
                <p><strong>Price:</strong> {% if product.price %}${{ product.price }}{% else %}Not set{% endif %}</p>
            </div>

            <div class="summary-item">
                <h3>Processing Information</h3>
                <p><strong>Processing Unit:</strong> {{ product.processing_unit.name|default:"N/A" }}</p>
                <p><strong>Category:</strong> {% if product.category %}{{ product.category.name }}{% else %}Not categorized{% endif %}</p>
                <p><strong>Manufacturer:</strong> {% if product.manufacturer %}{{ product.manufacturer }}{% else %}Not specified{% endif %}</p>
                <p><strong>Created:</strong> {{ product.created_at|date:"M d, Y H:i"|default:"N/A" }}</p>
            </div>

            {% if animal %}
            <div class="summary-item">
                <h3>Source Animal</h3>
                <p><strong>Animal ID:</strong> {{ animal.animal_id }}</p>
                <p><strong>Name:</strong> {% if animal.animal_name %}{{ animal.animal_name }}{% else %}Not named{% endif %}</p>
                <p><strong>Species:</strong> {{ animal.species }}</p>
                <p><strong>Farmer:</strong> {{ animal.farmer.username }}</p>
            </div>
            {% endif %}

            {% if qr_code_url %}
            <div class="summary-item qr-code">
                <h3>QR Code</h3>
                <img src="/media/{{ qr_code_url }}" alt="Product QR Code">
            </div>
            {% endif %}
    </div>

    {% if product.description %}
    <div class="mt-3 card">
        <strong>Description:</strong> {{ product.description }}
    </div>
    {% endif %}

    <div class="card mt-4 timeline">
        <h2>Product Lifecycle Timeline</h2>
        {% for event in timeline %}
        <div class="timeline-item">
            <div class="timeline-content">
                <div class="timeline-stage">{{ event.stage }}</div>
                <div class="timeline-timestamp">{{ event.timestamp|date:"M d, Y H:i:s" }}</div>
                <div class="timeline-location">{{ event.location }}</div>
                <div class="timeline-action">{{ event.action }}</div>
                {% if event.details %}
                <div class="timeline-details card mt-2 p-2">
                    <table>
                        {% for key, value in event.details.items %}
                        <tr>
                            <td>{{ key|title }}</td>
                            <td>{{ value }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                </div>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <p class="not-recorded">No timeline events recorded yet.</p>
        {% endfor %}
    </div>

    {% if inventory_items %}
    <div class="section">
        <h2>Current Inventory</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Shop</th>
                    <th>Quantity</th>
                    <th>Min Stock Level</th>
                    <th>Last Updated</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for item in inventory_items %}
                <tr>
                    <td>{{ item.shop.name }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>{{ item.min_stock_level }}</td>
                    <td>{{ item.last_updated|date:"M d, Y H:i" }}</td>
                    <td>
                        {% if item.is_low_stock %}
                        <span style="color: #dc3545; font-weight: bold;">Low Stock</span>
                        {% else %}
                        <span style="color: #28a745;">In Stock</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if receipts %}
    <div class="section">
        <h2>Receipt History</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Shop</th>
                    <th>Quantity Received</th>
                    <th>Received At</th>
                </tr>
            </thead>
            <tbody>
                {% for receipt in receipts %}
                <tr>
                    <td>{{ receipt.shop.name }}</td>
                    <td>{{ receipt.received_quantity }}</td>
                    <td>{{ receipt.received_at|date:"M d, Y H:i" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if order_items %}
    <div class="section">
        <h2>Sales History</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Order ID</th>
                    <th>Customer</th>
                    <th>Shop</th>
                    <th>Quantity</th>
                    <th>Unit Price</th>
                    <th>Subtotal</th>
                    <th>Order Date</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for item in order_items %}
                <tr>
                    <td>{{ item.order.id }}</td>
                    <td>{{ item.order.customer.username }}</td>
                    <td>{{ item.order.shop.name }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>${{ item.unit_price }}</td>
                    <td>${{ item.subtotal }}</td>
                    <td>{{ item.order.created_at|date:"M d, Y H:i" }}</td>
                    <td>
                        <span class="status-badge status-{{ item.order.status }}">
                            {{ item.order.status|title }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if carcass_measurement %}
    <div class="section">
        <h2>Carcass Measurements</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Measurement</th>
                    <th>Value</th>
                    <th>Unit</th>
                </tr>
            </thead>
            <tbody>
                {% for measurement in carcass_measurement %}
                <tr>
                    <td>{{ measurement.name|title }}</td>
                    <td>{{ measurement.value }}</td>
                    <td>{{ measurement.unit }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if inventory_count or receipts_count or orders_count %}
    <div class="section">
        <h2>Product Statistics</h2>
        <div class="summary-grid">
            <div class="summary-item">
                <h3>Inventory</h3>
                <p><strong>Current Stock:</strong> {{ inventory_count|default:0 }} locations</p>
            </div>
            <div class="summary-item">
                <h3>Receipts</h3>
                <p><strong>Total Received:</strong> {{ receipts_count|default:0 }} receipts</p>
            </div>
            <div class="summary-item">
                <h3>Sales</h3>
                <p><strong>Total Orders:</strong> {{ orders_count|default:0 }} orders</p>
            </div>
        </div>
    </div>
    {% endif %}
{% endblock %}
</body>
</html>

{% if debug_json %}
<script>
    try {
        var _meatTraceDebug = JSON.parse('{{ debug_json|escapejs }}');
        console.group('meat_trace: product_info debug');
        console.log('Product payload:', _meatTraceDebug.product);
        console.log('Animal payload:', _meatTraceDebug.animal);
        console.log('Timeline events:', _meatTraceDebug.timeline);
        console.log('Carcass measurement:', _meatTraceDebug.carcass_measurement);
        console.log('Counts: inventory=%s receipts=%s orders=%s', _meatTraceDebug.inventory_count, _meatTraceDebug.receipts_count, _meatTraceDebug.orders_count);
        console.groupEnd();
    } catch (e) {
        console.error('Failed to parse meat_trace debug JSON', e);
    }
</script>
{% endif %}